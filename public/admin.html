<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Write ‚Äî Ink & Pages Admin</title>
    <meta name="description" content="Create and manage blog posts for Ink & Pages." />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/styles.css">
    <link rel="stylesheet" href="styles/blog.css">
    <link rel="stylesheet" href="styles/admin.css">

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCxLfRhjINJFiSjGJ7Vg2kCHYH3t9eTDgA",
            authDomain: "dreamworld-f7a4b.firebaseapp.com",
            projectId: "dreamworld-f7a4b",
            storageBucket: "dreamworld-f7a4b.firebasestorage.app",
            messagingSenderId: "330382191425",
            appId: "1:330382191425:web:501903d678634f5eab4fc0"
        };

        // Initialize Firebase
        window.firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
        window.auth = getAuth(window.firebaseApp);
    </script>
</head>

<body>
    <div class="wrap admin-wrap" id="app">
        <header>
            <div class="brand">
                <div class="logo">IP</div>
                <div>
                    <h1><a href="index.html" style="color: inherit; text-decoration: none;">Ink & Pages</a></h1>
                    <div class="muted">Admin Panel</div>
                </div>
            </div>
            <nav class="nav">
                <a class="btn" href="index.html">Home</a>
                <a class="btn" href="blog.html">All Posts</a>
                <a class="btn btn-primary" href="admin.html">Write</a>
                <button class="btn" id="exportBtn">Export</button>

                <!-- Authentication navigation -->
                <div id="authNavigation">
                    <div id="guestNav">
                        <a class="btn" href="login.html">Sign In</a>
                    </div>

                    <div id="userNav" style="display: none;">
                        <a class="btn" href="user-dashboard.html" id="dashboardLink">Dashboard</a>
                        <span id="userDisplayName" style="color: var(--accent); font-size: 14px; margin: 0 8px;"></span>
                        <button class="btn" id="signOutBtn">Sign Out</button>
                    </div>
                </div>
                <button class="btn" id="importBtn">Import</button>
                <input type="file" id="importFile" accept=".json" style="display: none;">
            </nav>
        </header>

        <main class="admin-main">
            <!-- Editor Section -->
            <section class="editor-section" id="editorSection">
                <div class="editor-header">
                    <h2 id="editorTitle">Write New Post</h2>
                    <div class="editor-actions">
                        <button class="btn" id="previewBtn">Preview</button>
                        <button class="btn" id="saveDraftBtn">Save Draft</button>
                        <button class="btn btn-primary" id="publishBtn">Publish</button>
                        <button class="btn" id="cancelBtn" style="display: none;">Cancel</button>
                    </div>
                </div>

                <form class="editor-form" id="postForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="postTitle">Title</label>
                            <input type="text" id="postTitle" name="title" placeholder="Enter post title..." required>
                        </div>
                        <div class="form-group">
                            <label for="postSlug">Slug (URL)</label>
                            <input type="text" id="postSlug" name="slug" placeholder="auto-generated">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="postCategory">Category</label>
                            <select id="postCategory" name="category">
                                <option value="">Select category...</option>
                                <option value="fiction">Fiction</option>
                                <option value="craft">Writing Craft</option>
                                <option value="prompts">Prompts</option>
                                <option value="essays">Essays</option>
                                <option value="reviews">Reviews</option>
                                <option value="personal">Personal</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="postTags">Tags</label>
                            <input type="text" id="postTags" name="tags" placeholder="tag1, tag2, tag3...">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="postDate">Publish Date</label>
                            <input type="date" id="postDate" name="date">
                        </div>
                        <div class="form-group">
                            <label for="postStatus">Status</label>
                            <select id="postStatus" name="status">
                                <option value="draft">Draft</option>
                                <option value="published">Published</option>
                                <option value="scheduled">Scheduled</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="postExcerpt">Excerpt</label>
                        <textarea id="postExcerpt" name="excerpt" rows="3"
                            placeholder="Brief description of the post..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="postBody">Content</label>
                        <div class="editor-toolbar">
                            <button type="button" class="editor-btn" data-action="bold" title="Bold">B</button>
                            <button type="button" class="editor-btn" data-action="italic" title="Italic">I</button>
                            <button type="button" class="editor-btn" data-action="heading" title="Heading">#</button>
                            <button type="button" class="editor-btn" data-action="link" title="Link">üîó</button>
                            <button type="button" class="editor-btn" data-action="quote" title="Quote">‚ùù</button>
                            <button type="button" class="editor-btn" data-action="list" title="List">‚Ä¢</button>
                            <button type="button" class="editor-btn" data-action="code" title="Code">&lt;/&gt;</button>
                            <span class="separator">|</span>
                            <button type="button" class="editor-btn" data-action="undo" title="Undo">‚Ü∂</button>
                            <button type="button" class="editor-btn" data-action="redo" title="Redo">‚Ü∑</button>
                        </div>
                        <textarea id="postBody" name="body" rows="20"
                            placeholder="Start writing your post..."></textarea>
                        <div class="editor-meta">
                            <span id="wordCount">0 words</span>
                            <span id="readTime">0 min read</span>
                            <span id="charCount">0 characters</span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="postFeatured" name="featured">
                                Featured Post
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="postComments" name="allowComments" checked>
                                Allow Comments
                            </label>
                        </div>
                    </div>
                </form>
            </section>

            <!-- Posts Management Section -->
            <section class="posts-management" id="postsManagement">
                <div class="management-header">
                    <h2>Manage Posts</h2>
                    <div class="management-controls">
                        <input type="search" id="managementSearch" placeholder="Search posts...">
                        <select id="managementFilter">
                            <option value="">All Posts</option>
                            <option value="published">Published</option>
                            <option value="draft">Drafts</option>
                            <option value="scheduled">Scheduled</option>
                        </select>
                        <button class="btn btn-primary" id="newPostBtn">New Post</button>
                    </div>
                </div>

                <div class="posts-table-container">
                    <table class="posts-table" id="postsTable">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="postsTableBody">
                            <!-- Posts will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>

        <!-- Preview Modal -->
        <div class="overlay" id="previewOverlay">
            <div class="modal preview-modal">
                <div class="modal-header">
                    <h3>Preview</h3>
                    <button class="close" id="closePreview">Close</button>
                </div>
                <div class="preview-content" id="previewContent">
                    <!-- Preview will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="overlay" id="deleteModal">
            <div class="modal small-modal">
                <div class="modal-header">
                    <h3>Confirm Delete</h3>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this post? This action cannot be undone.</p>
                    <div class="modal-actions">
                        <button class="btn" id="cancelDelete">Cancel</button>
                        <button class="btn btn-danger" id="confirmDelete">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="scripts/firestore-admin.js" type="module"></script>

    <!-- Authentication integration for admin panel -->
    <script type="module">
        import authService from './scripts/auth.js';

        // DOM elements
        const guestNav = document.getElementById('guestNav');
        const userNav = document.getElementById('userNav');
        const userDisplayName = document.getElementById('userDisplayName');
        const signOutBtn = document.getElementById('signOutBtn');
        const adminApp = document.getElementById('app');

        // Create access denied screen
        function showAccessDenied() {
            adminApp.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; text-align: center;">
                    <h1 style="color: var(--accent); font-size: 3rem; margin-bottom: 1rem;">üîí</h1>
                    <h2 style="color: var(--text); margin-bottom: 1rem;">Access Denied</h2>
                    <p style="color: var(--muted); margin-bottom: 2rem; max-width: 400px;">
                        You need to be signed in with writing permissions to access the admin panel.
                    </p>
                    <div style="display: flex; gap: 1rem;">
                        <a href="login.html?returnUrl=${encodeURIComponent(window.location.href)}" class="btn btn-primary">
                            Sign In
                        </a>
                        <a href="index.html" class="btn">
                            Back to Home
                        </a>
                    </div>
                </div>
            `;
        }

        // Handle authentication state changes
        authService.onAuthStateChange = (user, role) => {
            if (!user) {
                // Not logged in - show access denied
                guestNav.style.display = 'flex';
                userNav.style.display = 'none';
                showAccessDenied();
                return;
            }

            // Check if user has permission to create posts
            if (!authService.hasPermission('canCreatePosts')) {
                // Logged in but no write permissions
                userNav.style.display = 'flex';
                guestNav.style.display = 'none';
                userDisplayName.textContent = user.displayName || user.email;

                adminApp.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; text-align: center;">
                        <h1 style="color: var(--accent); font-size: 3rem; margin-bottom: 1rem;">‚úã</h1>
                        <h2 style="color: var(--text); margin-bottom: 1rem;">Insufficient Permissions</h2>
                        <p style="color: var(--muted); margin-bottom: 2rem; max-width: 400px;">
                            Your account (${authService.formatRole(role)}) doesn't have writing permissions. 
                            Contact an administrator to request contributor access.
                        </p>
                        <div style="display: flex; gap: 1rem;">
                            <a href="user-dashboard.html" class="btn btn-primary">
                                Go to Dashboard
                            </a>
                            <a href="index.html" class="btn">
                                Back to Home
                            </a>
                        </div>
                    </div>
                `;
                return;
            }

            // User has permission - show normal interface
            guestNav.style.display = 'none';
            userNav.style.display = 'flex';
            userDisplayName.textContent = user.displayName || user.email;

            // Update UI based on role
            updateAdminUI(role);
        };

        // Update admin UI based on user role
        function updateAdminUI(role) {
            // Hide/show features based on permissions
            const managePostsSection = document.querySelector('.admin-section:nth-child(2)');
            const exportBtn = document.getElementById('exportBtn');

            // Contributors can only see their own posts, editors+ can see all
            if (authService.hasPermission('canViewDrafts')) {
                if (managePostsSection) managePostsSection.style.display = 'block';
                if (exportBtn) exportBtn.style.display = 'inline-flex';
            }

            // Update any role-specific messaging
            const roleIndicator = document.createElement('div');
            roleIndicator.style.cssText = `
                background: rgba(212, 175, 55, 0.1);
                border: 1px solid rgba(212, 175, 55, 0.3);
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 20px;
                color: var(--accent);
                font-size: 14px;
                text-align: center;
            `;

            let roleMessage = '';
            switch (role) {
                case 'contributor':
                    roleMessage = 'üìù You can write and edit your own posts. Published posts require editorial approval.';
                    break;
                case 'editor':
                    roleMessage = '‚ú® You can write, edit, and publish all posts. You can also manage categories.';
                    break;
                case 'admin':
                    roleMessage = 'üëë You have full administrative access to all blog features.';
                    break;
            }

            if (roleMessage) {
                roleIndicator.textContent = roleMessage;
                const adminContent = document.querySelector('.admin-content');
                if (adminContent) {
                    adminContent.insertBefore(roleIndicator, adminContent.firstChild);
                }
            }
        }

        // Handle sign out
        signOutBtn.addEventListener('click', async () => {
            try {
                await authService.signOut();
                // Will redirect via onAuthStateChange
            } catch (error) {
                console.error('Sign out error:', error);
                alert('Failed to sign out. Please try again.');
            }
        });

        console.log('Admin authentication initialized');
    </script>
</body>

</html>