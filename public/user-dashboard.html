<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - DreamLogTogether</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/styles.css">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f1419 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .header {
            background: #fff;
            padding: 30px 0;
            text-align: center;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 40px;
        }

        .header .title h1 {
            color: #1f2937;
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0 0 10px 0;
            letter-spacing: -0.025em;
        }

        .header .title h1 a {
            color: #1f2937;
            text-decoration: none;
        }

        .header .title h1 a:hover {
            color: #374151;
        }

        .header .title p {
            color: #6b7280;
            font-size: 1.1rem;
            font-weight: 500;
            margin: 0 0 25px 0;
        }

        .header .nav {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .header .nav .btn {
            padding: 10px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            color: #374151;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            background: #fff;
        }

        .header .nav .btn:hover {
            border-color: #6b7280;
            background: #f9fafb;
            transform: translateY(-2px);
        }

        .header .nav .btn-primary {
            background: #374151;
            color: #fff;
            border-color: #374151;
        }

        .header .nav .btn-primary:hover {
            background: #1f2937;
            border-color: #1f2937;
        }

        .header .nav .btn-secondary {
            background: #ef4444;
            color: #fff;
            border-color: #ef4444;
        }

        .header .nav .btn-secondary:hover {
            background: #dc2626;
            border-color: #dc2626;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        .dashboard-header {
            background: linear-gradient(145deg, #1e293b 0%, #334155 100%);
            border: 2px solid #475569;
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 25px;
            box-shadow:
                0 25px 50px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .dashboard-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #dc2626, #ea580c, #d97706, #0ea5e9, #0284c7, #374151);
        }

        .user-info h1 {
            color: #f8fafc;
            font-size: 2.2rem;
            font-weight: 800;
            margin: 0 0 15px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            letter-spacing: -0.025em;
        }

        .user-info .user-details {
            color: #cbd5e1;
            font-size: 1.1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .user-role {
            background: linear-gradient(145deg, #0ea5e9, #0284c7);
            color: #fff;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow:
                0 4px 14px rgba(14, 165, 233, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .dashboard-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: 2px solid transparent;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .btn-primary {
            background: linear-gradient(145deg, #0ea5e9, #0284c7);
            color: #fff;
            border-color: #0ea5e9;
        }

        .btn-primary:hover {
            background: linear-gradient(145deg, #0284c7, #0369a1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(145deg, #64748b, #475569);
            color: #fff;
            border-color: #64748b;
        }

        .btn-secondary:hover {
            background: linear-gradient(145deg, #475569, #334155);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(100, 116, 139, 0.4);
        }

        .btn-danger {
            background: linear-gradient(145deg, #dc2626, #b91c1c);
            color: #fff;
            border-color: #dc2626;
        }

        .btn-danger:hover {
            background: linear-gradient(145deg, #b91c1c, #991b1b);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .dashboard-card {
            background: linear-gradient(145deg, #1e293b, #334155);
            border: 2px solid #475569;
            border-radius: 16px;
            padding: 30px;
            box-shadow:
                0 25px 50px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow:
                0 35px 60px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
            border-color: #64748b;
        }

        .dashboard-card h3 {
            color: #f1f5f9;
            font-size: 1.4rem;
            font-weight: 700;
            margin: 0 0 25px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 25px 20px;
            background: linear-gradient(145deg, #374151, #4b5563);
            border: 2px solid #6b7280;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-3px);
            border-color: #9ca3af;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 900;
            color: #f1f5f9;
            display: block;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .stat-label {
            color: #e2e8f0;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .recent-posts {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .recent-post {
            padding: 20px;
            background: linear-gradient(145deg, #374151, #4b5563);
            border: 2px solid #6b7280;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .recent-post:hover {
            transform: translateX(5px);
            border-color: #9ca3af;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .post-info h4 {
            color: #f1f5f9;
            margin: 0 0 8px 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .post-meta {
            color: #cbd5e1;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .post-status {
            padding: 8px 16px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .status-published {
            background: linear-gradient(145deg, #16a34a, #15803d);
            color: #fff;
            box-shadow: 0 4px 14px rgba(22, 163, 74, 0.4);
        }

        .status-draft {
            background: linear-gradient(145deg, #d97706, #b45309);
            color: #fff;
            box-shadow: 0 4px 14px rgba(217, 119, 6, 0.4);
        }

        .status-pending {
            background: linear-gradient(145deg, #0ea5e9, #0284c7);
            color: #fff;
            box-shadow: 0 4px 14px rgba(14, 165, 233, 0.4);
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .quick-action {
            background: linear-gradient(145deg, #374151, #4b5563);
            border: 2px solid #6b7280;
            border-radius: 12px;
            padding: 25px 20px;
            text-align: center;
            text-decoration: none;
            color: #f1f5f9;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .quick-action::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .quick-action:hover {
            background: linear-gradient(145deg, #4b5563, #6b7280);
            transform: translateY(-5px);
            border-color: #9ca3af;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }

        .quick-action:hover::before {
            left: 100%;
        }

        .quick-action-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            display: block;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
        }

        .quick-action span:last-child {
            font-weight: 600;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .profile-section {
            margin-top: 40px;
        }

        .profile-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            color: #e2e8f0;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #475569;
            border-radius: 10px;
            background: linear-gradient(145deg, #374151, #4b5563);
            color: #f8fafc;
            font-size: 1rem;
            font-weight: 500;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
        }

        .form-group input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .admin-panel-link {
            background: linear-gradient(145deg, #dc2626, #b91c1c);
            color: #fff;
            border-color: #dc2626;
        }

        .admin-panel-link:hover {
            background: linear-gradient(145deg, #b91c1c, #991b1b);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 20px;
            }

            .dashboard-header {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
                padding: 30px 25px;
            }

            .user-info .user-details {
                justify-content: center;
                margin-bottom: 20px;
            }

            .dashboard-actions {
                justify-content: center;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }

            .recent-post {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="title">
            <h1><a href="index.html">DreamLogTogether</a></h1>
            <p>Your Personal Blog Dashboard</p>
        </div>
        <nav class="nav">
            <a class="btn" href="index.html">Home</a>
            <a class="btn" href="blog.html">Blog</a>
            <a class="btn" href="categories.html">Categories</a>
            <a class="btn" href="about.html">About</a>
            <a class="btn" href="contact.html">Contact</a>
            <a class="btn btn-primary" href="user-dashboard.html">Dashboard</a>
            <button class="btn btn-secondary" id="signOutBtn">Sign Out</button>
        </nav>
    </div>

    <div class="dashboard-container">
        <!-- User Header -->
        <div class="dashboard-header">
            <div class="user-info">
                <h1 id="userDisplayName">Welcome Back!</h1>
                <div class="user-details">
                    <span id="userEmail"></span> ‚Ä¢
                    <span class="user-role" id="userRole">User</span>
                </div>
            </div>
            <div class="dashboard-actions">
                <a href="index.html" class="btn btn-secondary">View Blog</a>
                <a href="#" id="newPostBtn" class="btn btn-primary hidden">New Post</a>
                <a href="admin.html" id="adminPanelBtn" class="btn admin-panel-link hidden">Admin Panel</a>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Stats Card -->
            <div class="dashboard-card">
                <h3>üìä Your Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-number" id="totalPosts">0</span>
                        <span class="stat-label">Total Posts</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="publishedPosts">0</span>
                        <span class="stat-label">Published</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="draftPosts">0</span>
                        <span class="stat-label">Drafts</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="totalViews">0</span>
                        <span class="stat-label">Total Views</span>
                    </div>
                </div>
            </div>

            <!-- Recent Posts -->
            <div class="dashboard-card">
                <h3>üìù Recent Posts</h3>
                <ul class="recent-posts" id="recentPostsList">
                    <li style="text-align: center; color: #999; padding: 20px;">
                        No posts yet. Create your first post!
                    </li>
                </ul>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="dashboard-card">
            <h3>‚ö° Quick Actions</h3>
            <div class="quick-actions" id="quickActions">
                <a href="blog.html" class="quick-action">
                    <span class="quick-action-icon">üìñ</span>
                    <span>Browse Blog</span>
                </a>
                <a href="categories.html" class="quick-action">
                    <span class="quick-action-icon">üè∑Ô∏è</span>
                    <span>View Categories</span>
                </a>
            </div>
        </div>

        <!-- Profile Section -->
        <div class="dashboard-card profile-section">
            <h3>üë§ Profile Settings</h3>
            <form class="profile-form" id="profileForm">
                <div class="form-group">
                    <label for="profileDisplayName">Display Name</label>
                    <input type="text" id="profileDisplayName" name="displayName">
                </div>
                <div class="form-group">
                    <label for="profileEmail">Email</label>
                    <input type="email" id="profileEmail" name="email" disabled>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Update Profile</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import authService from './scripts/auth.js';

        // DOM elements
        const userDisplayName = document.getElementById('userDisplayName');
        const userEmail = document.getElementById('userEmail');
        const userRole = document.getElementById('userRole');
        const signOutBtn = document.getElementById('signOutBtn');
        const newPostBtn = document.getElementById('newPostBtn');
        const adminPanelBtn = document.getElementById('adminPanelBtn');
        const totalPosts = document.getElementById('totalPosts');
        const publishedPosts = document.getElementById('publishedPosts');
        const draftPosts = document.getElementById('draftPosts');
        const totalViews = document.getElementById('totalViews');
        const recentPostsList = document.getElementById('recentPostsList');
        const quickActions = document.getElementById('quickActions');
        const profileForm = document.getElementById('profileForm');
        const profileDisplayName = document.getElementById('profileDisplayName');
        const profileEmail = document.getElementById('profileEmail');

        // Auth state change handler
        authService.onAuthStateChange = async (user, role) => {
            if (!user) {
                // Redirect to login if not authenticated
                window.location.href = 'login.html?returnUrl=' + encodeURIComponent(window.location.href);
                return;
            }

            // Update user info
            updateUserInfo(user, role);

            // Load user data
            await loadUserData(user, role);

            // Setup role-specific features
            setupRoleFeatures(role);
        };

        // Update user info display
        function updateUserInfo(user, role) {
            userDisplayName.textContent = `Welcome back, ${user.displayName || 'User'}!`;
            userEmail.textContent = user.email;
            userRole.textContent = authService.formatRole(role);

            // Update profile form
            profileDisplayName.value = user.displayName || '';
            profileEmail.value = user.email;
        }

        // Load user data and stats
        async function loadUserData(user, role) {
            try {
                // This would integrate with the blog system to get user's posts
                // For now, we'll use placeholder data

                // Mock data - in real implementation, this would query Firestore
                const userStats = {
                    total: 0,
                    published: 0,
                    drafts: 0,
                    views: 0
                };

                totalPosts.textContent = userStats.total;
                publishedPosts.textContent = userStats.published;
                draftPosts.textContent = userStats.drafts;
                totalViews.textContent = userStats.views;

                // Load recent posts (placeholder)
                loadRecentPosts(user.uid);

            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Load recent posts
        function loadRecentPosts(userId) {
            // Placeholder for recent posts
            // In real implementation, this would query user's posts from Firestore
            const posts = []; // Mock empty array

            if (posts.length === 0) {
                recentPostsList.innerHTML = `
                    <li style="text-align: center; color: #999; padding: 20px;">
                        No posts yet. Create your first post!
                    </li>
                `;
                return;
            }

            recentPostsList.innerHTML = posts.map(post => `
                <li class="recent-post">
                    <div class="post-info">
                        <h4>${post.title}</h4>
                        <div class="post-meta">${new Date(post.createdAt).toLocaleDateString()}</div>
                    </div>
                    <span class="post-status status-${post.status}">${post.status}</span>
                </li>
            `).join('');
        }

        // Setup role-specific features
        function setupRoleFeatures(role) {
            // Show/hide features based on role
            if (authService.hasPermission('canCreatePosts')) {
                newPostBtn.classList.remove('hidden');

                // Add quick action for creating posts
                const createPostAction = document.createElement('a');
                createPostAction.href = 'admin.html';
                createPostAction.className = 'quick-action';
                createPostAction.innerHTML = `
                    <span class="quick-action-icon">‚úçÔ∏è</span>
                    <span>Write Post</span>
                `;
                quickActions.appendChild(createPostAction);
            }

            if (authService.isSuperAdmin()) {
                adminPanelBtn.classList.remove('hidden');

                // Add super admin quick actions
                const manageUsersAction = document.createElement('a');
                manageUsersAction.href = 'user-management.html';
                manageUsersAction.className = 'quick-action';
                manageUsersAction.innerHTML = `
                    <span class="quick-action-icon">üë•</span>
                    <span>Manage Users</span>
                `;
                quickActions.appendChild(manageUsersAction);

                const managePostsAction = document.createElement('a');
                managePostsAction.href = 'posts-management.html';
                managePostsAction.className = 'quick-action';
                managePostsAction.innerHTML = `
                    <span class="quick-action-icon">üìù</span>
                    <span>Manage Posts</span>
                `;
                quickActions.appendChild(managePostsAction);

                const managePetitionsAction = document.createElement('a');
                managePetitionsAction.href = 'petition-management.html';
                managePetitionsAction.className = 'quick-action';
                managePetitionsAction.innerHTML = `
                    <span class="quick-action-icon">üìã</span>
                    <span>Writer Petitions</span>
                `;
                quickActions.appendChild(managePetitionsAction);

                const settingsAction = document.createElement('a');
                settingsAction.href = '#';
                settingsAction.className = 'quick-action';
                settingsAction.innerHTML = `
                    <span class="quick-action-icon">‚öôÔ∏è</span>
                    <span>Site Settings</span>
                `;
                settingsAction.addEventListener('click', (e) => {
                    e.preventDefault();
                    alert('Site settings panel coming soon!');
                });
                quickActions.appendChild(settingsAction);

            } else if (authService.isAdmin()) {
                adminPanelBtn.classList.remove('hidden');

                // Add admin quick actions
                const manageUsersAction = document.createElement('a');
                manageUsersAction.href = '#';
                manageUsersAction.className = 'quick-action';
                manageUsersAction.innerHTML = `
                    <span class="quick-action-icon">üë•</span>
                    <span>View Users</span>
                `;
                manageUsersAction.addEventListener('click', (e) => {
                    e.preventDefault();
                    showUserManagement();
                });
                quickActions.appendChild(manageUsersAction);
            }

            if (authService.hasPermission('canViewDrafts')) {
                const manageDraftsAction = document.createElement('a');
                manageDraftsAction.href = 'admin.html';
                manageDraftsAction.className = 'quick-action';
                manageDraftsAction.innerHTML = `
                    <span class="quick-action-icon">üìã</span>
                    <span>Manage Posts</span>
                `;
                quickActions.appendChild(manageDraftsAction);
            }

            // Add petition access for regular users
            if (!authService.hasPermission('canWrite') && !authService.isSuperAdmin() && !authService.isAdmin()) {
                const petitionAction = document.createElement('a');
                petitionAction.href = 'writer-petition.html';
                petitionAction.className = 'quick-action';
                petitionAction.innerHTML = `
                    <span class="quick-action-icon">‚úçÔ∏è</span>
                    <span>Become a Writer</span>
                `;
                quickActions.appendChild(petitionAction);
            }
        }

        // Show user management (admin only)
        async function showUserManagement() {
            if (!authService.isAdmin()) {
                alert('Access denied. Admin privileges required.');
                return;
            }

            try {
                const users = await authService.getAllUsers();
                // This would open a modal or navigate to user management page
                // For now, just log the users
                console.log('All users:', users);
                alert(`Found ${users.length} users. Check console for details.`);
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Failed to load users.');
            }
        }

        // Handle sign out
        signOutBtn.addEventListener('click', async () => {
            try {
                await authService.signOut();
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Sign out error:', error);
                alert('Failed to sign out. Please try again.');
            }
        });

        // Handle new post button
        newPostBtn.addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = 'admin.html';
        });

        // Handle profile form submission
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(profileForm);
            const displayName = formData.get('displayName');

            try {
                profileForm.classList.add('loading');

                // Update display name in Firebase Auth
                await authService.auth.currentUser.updateProfile({ displayName });

                // Update user document in Firestore
                await authService.updateUserDocument(authService.currentUser.uid, {
                    displayName: displayName
                });

                alert('Profile updated successfully!');
                userDisplayName.textContent = `Welcome back, ${displayName}!`;

            } catch (error) {
                console.error('Profile update error:', error);
                alert('Failed to update profile. Please try again.');
            } finally {
                profileForm.classList.remove('loading');
            }
        });

        // Initialize dashboard
        console.log('Dashboard initialized');
    </script>
</body>

</html>