<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Writer Petitions Management - Dream Log Together</title>
    <link rel="stylesheet" href="styles/styles.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: #fff;
            padding: 30px 0;
            text-align: center;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 40px;
        }

        .header .title h1 {
            color: #1f2937;
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0 0 10px 0;
            letter-spacing: -0.025em;
        }

        .header .title h1 a {
            color: #1f2937;
            text-decoration: none;
        }

        .header .title h1 a:hover {
            color: #374151;
        }

        .header .title p {
            color: #6b7280;
            font-size: 1.1rem;
            font-weight: 500;
            margin: 0 0 25px 0;
        }

        .header .nav {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .header .nav .btn {
            padding: 10px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            color: #374151;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            background: #fff;
        }

        .header .nav .btn:hover {
            border-color: #6b7280;
            background: #f9fafb;
            transform: translateY(-2px);
        }

        .header .nav .btn-primary {
            background: #374151;
            color: #fff;
            border-color: #374151;
        }

        .header .nav .btn-primary:hover {
            background: #1f2937;
            border-color: #1f2937;
        }

        .management-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-card.pending {
            border-color: #fbbf24;
        }

        .stat-card.approved {
            border-color: #10b981;
        }

        .stat-card.rejected {
            border-color: #ef4444;
        }

        .stat-card h3 {
            color: #374151;
            font-size: 1.8rem;
            margin: 0 0 10px 0;
            font-weight: 700;
        }

        .stat-card .number {
            font-size: 3rem;
            font-weight: 800;
            margin: 10px 0;
        }

        .stat-card.pending .number {
            color: #f59e0b;
        }

        .stat-card.approved .number {
            color: #059669;
        }

        .stat-card.rejected .number {
            color: #dc2626;
        }

        .petitions-section {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .section-header {
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            color: #fff;
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .section-header h2 {
            font-size: 1.8rem;
            margin: 0;
            font-weight: 700;
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: transparent;
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .petitions-content {
            padding: 0;
        }

        .petition-item {
            border-bottom: 2px solid #f1f5f9;
            padding: 30px 40px;
            transition: all 0.3s ease;
        }

        .petition-item:hover {
            background: #f8fafc;
        }

        .petition-item:last-child {
            border-bottom: none;
        }

        .petition-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .petition-info h3 {
            color: #1f2937;
            font-size: 1.4rem;
            margin: 0 0 8px 0;
            font-weight: 600;
        }

        .petition-meta {
            color: #6b7280;
            font-size: 0.95rem;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.approved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .petition-details {
            margin-bottom: 25px;
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-section h4 {
            color: #374151;
            font-size: 1.1rem;
            margin: 0 0 8px 0;
            font-weight: 600;
        }

        .detail-section p {
            color: #64748b;
            line-height: 1.6;
            margin: 0;
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #e2e8f0;
        }

        .petition-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        .action-btn.approve {
            background: #10b981;
            color: #fff;
        }

        .action-btn.approve:hover {
            background: #059669;
        }

        .action-btn.reject {
            background: #ef4444;
            color: #fff;
        }

        .action-btn.reject:hover {
            background: #dc2626;
        }

        .action-btn.view {
            background: #6366f1;
            color: #fff;
        }

        .action-btn.view:hover {
            background: #4f46e5;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .empty-state {
            text-align: center;
            padding: 60px 40px;
            color: #6b7280;
        }

        .empty-state h3 {
            color: #374151;
            margin-bottom: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: #fff;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            color: #fff;
            padding: 25px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.4rem;
        }

        .close {
            color: #fff;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.8;
        }

        .close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
        }

        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-family: inherit;
            resize: vertical;
            box-sizing: border-box;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding: 25px 30px;
            background: #f8fafc;
            border-radius: 0 0 15px 15px;
        }

        @media (max-width: 768px) {
            .management-container {
                padding: 0 10px;
            }

            .petition-item {
                padding: 20px;
            }

            .petition-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .petition-actions {
                width: 100%;
            }

            .action-btn {
                flex: 1;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="title">
            <h1><a href="index.html">Dream Log Together</a></h1>
            <p>Writer Petitions Management</p>
        </div>
        <nav class="nav">
            <a href="index.html" class="btn">Home</a>
            <a href="blog.html" class="btn">Blog</a>
            <a href="user-dashboard.html" class="btn">Dashboard</a>
            <a href="user-management.html" class="btn">Users</a>
            <a href="posts-management.html" class="btn">Posts</a>
            <a href="petition-management.html" class="btn btn-primary">Writer Petitions</a>
            <a href="#" id="logoutBtn" class="btn">Sign Out</a>
        </nav>
    </div>

    <div class="management-container">
        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card pending">
                <h3>Pending Petitions</h3>
                <div class="number" id="pendingCount">-</div>
                <p>Awaiting Review</p>
            </div>
            <div class="stat-card approved">
                <h3>Approved This Month</h3>
                <div class="number" id="approvedCount">-</div>
                <p>New Writers</p>
            </div>
            <div class="stat-card rejected">
                <h3>Total Processed</h3>
                <div class="number" id="totalCount">-</div>
                <p>All Time</p>
            </div>
        </div>

        <!-- Petitions List -->
        <div class="petitions-section">
            <div class="section-header">
                <h2>üìù Writer Petitions</h2>
                <div class="filter-controls">
                    <button class="filter-btn active" data-status="all">All</button>
                    <button class="filter-btn" data-status="pending">Pending</button>
                    <button class="filter-btn" data-status="approved">Approved</button>
                    <button class="filter-btn" data-status="rejected">Rejected</button>
                </div>
            </div>

            <div class="petitions-content" id="petitionsContainer">
                <div class="loading-spinner">
                    <p>Loading petitions...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Review Petition</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="reviewNotes">Review Notes (Optional)</label>
                    <textarea id="reviewNotes" rows="4" placeholder="Add any notes about your decision..."></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="action-btn" onclick="closeModal()">Cancel</button>
                <button type="button" class="action-btn approve" id="confirmApprove">Approve</button>
                <button type="button" class="action-btn reject" id="confirmReject">Reject</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="scripts/firebase.js"></script>
    <script src="scripts/auth.js"></script>
    <script src="scripts/superadmin-guard.js"></script>
    <script>
        let currentUser = null;
        let currentFilter = 'all';
        let allPetitions = [];

        function renderError(message) {
            const container = document.getElementById('petitions-list');
            const loginButton = !currentUser ?
                '<button onclick="window.location.href=\'login.html\'" style="margin-top: 20px; padding: 10px 20px; background: #4ecdc4; color: white; border: none; border-radius: 5px; cursor: pointer;">Go to Login</button>' :
                '';
            const debugButton = window.location.search.includes('debug=true') || window.location.hostname === 'localhost' ?
                '<button onclick="checkSuperAdmin()" style="margin-top: 10px; margin-left: 10px; padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer;">Check Super Admin Status</button>' :
                '';

            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <h3>‚ö†Ô∏è ${message}</h3>
                    ${loginButton}
                    ${debugButton}
                </div>
            `;
        }
        let currentPetitionId = null;

        // Initialize Super Admin Guard
        window.addEventListener('load', () => {
            setTimeout(() => {
                window.superAdminGuard.init({
                    redirectUrl: 'user-dashboard.html',
                    loginUrl: 'login.html',
                    errorMessage: 'Access denied. Super Administrator privileges required for petition management.',
                    showError: true
                });
            }, 1000);
        });

        // Listen for access granted event
        window.addEventListener('superAdminAccessGranted', async (event) => {
            currentUser = event.detail.user;
            console.log('‚úÖ Super admin access granted, loading petitions...');
            await loadPetitions();
        });

        // Also listen for auth state changes for other functionality
        firebase.auth().onAuthStateChanged(async (user) => {
            currentUser = user;
            // The guard will handle access control, we just update the current user
        });        // Load all petitions
        async function loadPetitions() {
            try {
                console.log('üîÑ Loading petitions...');
                console.log('Current user:', currentUser?.email);
                console.log('Firebase initialized:', !!firebase.firestore);
                console.log('Auth service loaded:', !!window.authService);
                console.log('User role:', window.authService?.userRole);
                console.log('Is super admin:', window.authService?.isSuperAdmin());

                // Check authentication status
                if (!currentUser) {
                    console.error('‚ùå No authenticated user');
                    renderError('Please sign in to access petition management');
                    return;
                }

                if (!window.authService?.isSuperAdmin()) {
                    console.error('‚ùå User is not super admin. Role:', window.authService?.userRole);
                    renderError('Access denied: Super Administrator permissions required');
                    return;
                }

                // Test if we can access Firestore at all
                try {
                    console.log('Testing Firestore access...');
                    const testQuery = await firebase.firestore().collection('test-collection').limit(1).get();
                    console.log('Firestore access test successful');
                } catch (accessError) {
                    console.error('Firestore access test failed:', accessError);
                }

                // First try to get petitions without ordering to avoid index issues
                let snapshot;
                try {
                    console.log('Attempting ordered query...');
                    snapshot = await firebase.firestore()
                        .collection('writer-petitions')
                        .orderBy('submittedAt', 'desc')
                        .get();
                    console.log('Ordered query successful');
                } catch (indexError) {
                    console.warn('Ordered query failed, trying without ordering:', indexError);
                    // Fallback to unordered query if index doesn't exist
                    try {
                        snapshot = await firebase.firestore()
                            .collection('writer-petitions')
                            .get();
                        console.log('Unordered query successful');
                    } catch (fallbackError) {
                        console.error('Both queries failed:', fallbackError);
                        throw fallbackError;
                    }
                }

                console.log('Query snapshot empty?', snapshot.empty);
                console.log('Query snapshot size:', snapshot.size);

                allPetitions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Sort manually if we got unordered results
                if (allPetitions.length > 0) {
                    allPetitions.sort((a, b) => {
                        const aTime = a.submittedAt?.toDate ? a.submittedAt.toDate() : new Date(a.submittedAt || 0);
                        const bTime = b.submittedAt?.toDate ? b.submittedAt.toDate() : new Date(b.submittedAt || 0);
                        return bTime - aTime; // Descending order
                    });
                }

                console.log('Loaded petitions:', allPetitions.length, allPetitions);
                updateStatistics();
                displayPetitions();
            } catch (error) {
                console.error('Error loading petitions:', error);
                document.getElementById('petitionsContainer').innerHTML = `
                    <div class="empty-state">
                        <h3>Error loading petitions</h3>
                        <p>Please refresh the page and try again.</p>
                        <p><small>Error: ${error.message}</small></p>
                    </div>
                `;
            }
        }

        // Update statistics
        function updateStatistics() {
            const pending = allPetitions.filter(p => p.status === 'pending').length;
            const approved = allPetitions.filter(p => p.status === 'approved').length;
            const total = allPetitions.length;

            console.log('Statistics:', { total, pending, approved });

            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('approvedCount').textContent = approved;
            document.getElementById('totalCount').textContent = total;
        }

        // Display petitions based on current filter
        function displayPetitions() {
            console.log('Displaying petitions. Total:', allPetitions.length, 'Current filter:', currentFilter);

            const container = document.getElementById('petitionsContainer');
            const filteredPetitions = currentFilter === 'all'
                ? allPetitions
                : allPetitions.filter(p => p.status === currentFilter);

            console.log('Filtered petitions:', filteredPetitions.length);

            if (filteredPetitions.length === 0) {
                console.log('No petitions to display');
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No petitions found</h3>
                        <p>${currentFilter === 'all' ? 'No writer petitions have been submitted yet.' : `No ${currentFilter} petitions found.`}</p>
                        <p><small>Debug: Total petitions: ${allPetitions.length}, Filter: ${currentFilter}</small></p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredPetitions.map(petition => `
                <div class="petition-item">
                    <div class="petition-header">
                        <div class="petition-info">
                            <h3>${petition.fullName}</h3>
                            <div class="petition-meta">
                                <span>üìß ${petition.userEmail}</span>
                                <span>üìÖ ${formatDate(petition.submittedAt)}</span>
                            </div>
                        </div>
                        <span class="status-badge ${petition.status}">${petition.status}</span>
                    </div>
                    
                    <div class="petition-details">
                        <div class="detail-section">
                            <h4>Writing Experience</h4>
                            <p>${petition.writingExperience}</p>
                        </div>
                        
                        <div class="detail-section">
                            <h4>Content Plans</h4>
                            <p>${petition.contentPlan}</p>
                        </div>
                        
                        <div class="detail-section">
                            <h4>Writing Sample</h4>
                            <p>${petition.writingSample}</p>
                        </div>
                        
                        <div class="detail-section">
                            <h4>Motivation</h4>
                            <p>${petition.motivation}</p>
                        </div>
                        
                        ${petition.reviewNotes ? `
                            <div class="detail-section">
                                <h4>Review Notes</h4>
                                <p>${petition.reviewNotes}</p>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="petition-actions">
                        ${petition.status === 'pending' ? `
                            <button class="action-btn approve" onclick="showReviewModal('${petition.id}', 'approve')">
                                ‚úÖ Approve
                            </button>
                            <button class="action-btn reject" onclick="showReviewModal('${petition.id}', 'reject')">
                                ‚ùå Reject
                            </button>
                        ` : ''}
                        <button class="action-btn view" onclick="viewUserProfile('${petition.userId}')">
                            üë§ View User
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.status;
                displayPetitions();
            });
        });

        // Show review modal
        function showReviewModal(petitionId, action) {
            currentPetitionId = petitionId;
            document.getElementById('modalTitle').textContent = `${action.charAt(0).toUpperCase() + action.slice(1)} Petition`;
            document.getElementById('reviewNotes').value = '';

            // Show/hide buttons based on action
            document.getElementById('confirmApprove').style.display = action === 'approve' ? 'block' : 'none';
            document.getElementById('confirmReject').style.display = action === 'reject' ? 'block' : 'none';

            document.getElementById('reviewModal').style.display = 'block';
        }

        // Close modal
        function closeModal() {
            document.getElementById('reviewModal').style.display = 'none';
            currentPetitionId = null;
        }

        // Handle modal actions
        document.getElementById('confirmApprove').addEventListener('click', () => processPetition('approved'));
        document.getElementById('confirmReject').addEventListener('click', () => processPetition('rejected'));

        // Process petition (approve/reject)
        async function processPetition(status) {
            if (!currentPetitionId) return;

            try {
                const reviewNotes = document.getElementById('reviewNotes').value.trim();
                const petition = allPetitions.find(p => p.id === currentPetitionId);

                if (!petition) {
                    throw new Error('Petition not found');
                }

                // Update petition status
                await firebase.firestore()
                    .collection('writer-petitions')
                    .doc(currentPetitionId)
                    .update({
                        status: status,
                        reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        reviewedBy: currentUser.uid,
                        reviewNotes: reviewNotes || null
                    });

                // If approved, promote user to writer role
                if (status === 'approved') {
                    await firebase.firestore()
                        .collection('users')
                        .doc(petition.userId)
                        .update({
                            role: 'contributor',
                            roleUpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            roleUpdatedBy: currentUser.uid
                        });
                }

                // Refresh data
                await loadPetitions();
                closeModal();

                alert(`Petition ${status} successfully!${status === 'approved' ? ' User has been promoted to writer role.' : ''}`);
            } catch (error) {
                console.error('Error processing petition:', error);
                alert('Error processing petition. Please try again.');
            }
        }

        // View user profile
        function viewUserProfile(userId) {
            // This would typically open a user profile modal or navigate to user details
            alert(`View user profile: ${userId}\n(This feature can be implemented to show full user details)`);
        }

        // Format date helper
        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('reviewModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        // Close modal with X button
        document.querySelector('.close').onclick = closeModal;

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await firebase.auth().signOut();
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Error signing out:', error);
            }
        });

        // DEBUG: Function to check and create super admin user
        async function checkSuperAdmin() {
            console.log('üîç Checking super admin status...');

            if (!currentUser) {
                console.log('‚ùå No user logged in');
                return;
            }

            console.log('Current user:', {
                email: currentUser.email,
                uid: currentUser.uid,
                displayName: currentUser.displayName
            });

            try {
                // Check user document in Firestore
                const userDoc = await db.collection('users').doc(currentUser.uid).get();

                if (!userDoc.exists) {
                    console.log('‚ùå User document does not exist in Firestore');
                    console.log('Creating user document...');

                    const userData = {
                        email: currentUser.email,
                        displayName: currentUser.displayName || 'Super Administrator',
                        role: 'super_admin',
                        createdAt: new Date(),
                        isActive: true,
                        lastLogin: new Date()
                    };

                    await db.collection('users').doc(currentUser.uid).set(userData);
                    console.log('‚úÖ User document created with super_admin role');

                    // Refresh auth service
                    if (window.authService) {
                        await window.authService.loadUserRole();
                        console.log('‚úÖ User role refreshed:', window.authService.userRole);
                    }
                } else {
                    const userData = userDoc.data();
                    console.log('‚úÖ User document exists:', userData);

                    if (userData.role !== 'super_admin') {
                        console.log('‚ö†Ô∏è User role is not super_admin, updating...');
                        await db.collection('users').doc(currentUser.uid).update({
                            role: 'super_admin',
                            updatedAt: new Date()
                        });
                        console.log('‚úÖ User role updated to super_admin');

                        // Refresh auth service
                        if (window.authService) {
                            await window.authService.loadUserRole();
                            console.log('‚úÖ User role refreshed:', window.authService.userRole);
                        }
                    }
                }

            } catch (error) {
                console.error('‚ùå Error checking super admin:', error);
            }
        }

        // DEBUG: Function to create single test petition for debugging
        async function createSingleTestPetition() {
            if (!currentUser || !firebase.firestore) {
                console.error('User not authenticated or Firestore not available');
                return;
            }

            try {
                console.log('Creating single test petition...');

                const testPetition = {
                    userId: `test-user-single-${Date.now()}`,
                    userEmail: 'single.test@example.com',
                    fullName: 'Single Test Writer',
                    writingExperience: 'This is a single test petition created for debugging purposes.',
                    contentPlan: 'Testing content plan for debugging.',
                    writingSample: 'This is a test writing sample used for debugging the petition system.',
                    motivation: 'This petition was created automatically for testing purposes.',
                    status: 'pending',
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    reviewedAt: null,
                    reviewedBy: null,
                    reviewNotes: null
                };

                const docRef = await db.collection('writer-petitions').add(testPetition);
                console.log('‚úÖ Single test petition created with ID:', docRef.id);

                // Wait a moment then refresh
                setTimeout(() => {
                    loadPetitions();
                }, 1000);

            } catch (error) {
                console.error('‚ùå Error creating single test petition:', error);
            }
        }

        // DEBUG: Function to create test petitions for debugging
        async function createTestPetitions() {
            if (!currentUser || !firebase.firestore) {
                console.error('User not authenticated or Firestore not available');
                return;
            }

            try {
                console.log('Creating test petitions...');

                const testPetitions = [
                    {
                        userId: 'test-user-1',
                        userEmail: 'john.writer@example.com',
                        fullName: 'John Writer',
                        writingExperience: 'I have been writing for over 5 years, with experience in creative writing, journalism, and technical documentation. Published several articles in local magazines.',
                        contentPlan: 'I plan to write about technology trends, personal development, and creative storytelling. My focus will be on engaging content that educates and inspires readers.',
                        writingSample: 'The morning sun cast long shadows across the digital landscape of our modern world. As we navigate through endless streams of information, the art of storytelling becomes more crucial than ever. Writers today must balance creativity with clarity, ensuring their message resonates in an increasingly noisy world.',
                        motivation: 'I want to join this platform to share my knowledge and experiences with a wider audience. Writing has always been my passion, and I believe I can contribute valuable content that helps others grow and learn.',
                        status: 'pending',
                        submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        reviewedAt: null,
                        reviewedBy: null,
                        reviewNotes: null
                    },
                    {
                        userId: 'test-user-2',
                        userEmail: 'sarah.creative@example.com',
                        fullName: 'Sarah Creative',
                        writingExperience: 'Professional content creator with 3+ years of experience. Specialized in blog writing, social media content, and marketing copy. Graduate degree in English Literature.',
                        contentPlan: 'My content will focus on creativity, lifestyle tips, and personal growth. I enjoy writing how-to guides and inspirational pieces that motivate people to pursue their dreams.',
                        writingSample: 'Creativity is not a talent reserved for the chosen few‚Äîit is a skill that can be cultivated and nurtured. In my years as a content creator, I have discovered that the most powerful stories come from authentic experiences and genuine emotions. Every person has a unique perspective worth sharing.',
                        motivation: 'This platform represents an opportunity to connect with like-minded individuals and share knowledge that can make a real difference in people\'s lives. I am excited about the possibility of contributing to a community of passionate writers.',
                        status: 'pending',
                        submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        reviewedAt: null,
                        reviewedBy: null,
                        reviewNotes: null
                    },
                    {
                        userId: 'test-user-3',
                        userEmail: 'mike.approved@example.com',
                        fullName: 'Mike Approved',
                        writingExperience: 'Freelance writer with extensive experience in tech writing and tutorials. Former software developer turned writer, bringing technical expertise to content creation.',
                        contentPlan: 'I want to create comprehensive guides and tutorials that help people understand complex topics in simple terms. My background in technology gives me a unique perspective on emerging trends.',
                        writingSample: 'The intersection of technology and human creativity continues to evolve at an unprecedented pace. As artificial intelligence and machine learning reshape our world, writers must adapt while maintaining the human touch that makes content truly valuable and relatable.',
                        motivation: 'I believe in the power of education through accessible writing. My goal is to bridge the gap between complex technical concepts and everyday understanding, making knowledge available to everyone.',
                        status: 'approved',
                        submittedAt: firebase.firestore.Timestamp.fromDate(new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)), // 7 days ago
                        reviewedAt: firebase.firestore.Timestamp.fromDate(new Date(Date.now() - 5 * 24 * 60 * 60 * 1000)), // 5 days ago
                        reviewedBy: currentUser.uid,
                        reviewNotes: 'Excellent writing sample and clear content plan. Approved for contributor role.'
                    }
                ];

                for (let i = 0; i < testPetitions.length; i++) {
                    await firebase.firestore()
                        .collection('writer-petitions')
                        .add(testPetitions[i]);
                    console.log(`Created test petition ${i + 1}`);
                }

                console.log('All test petitions created successfully!');
                alert('Test petitions created! Refreshing page...');
                window.location.reload();
            } catch (error) {
                console.error('Error creating test petitions:', error);
                alert('Error creating test petitions: ' + error.message);
            }
        }

        // Add debug panel (for debugging)
        if (window.location.hostname === 'localhost' || window.location.search.includes('debug=true')) {
            const debugPanel = document.createElement('div');
            debugPanel.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 9999; background: rgba(0,0,0,0.9); color: white; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px;';
            debugPanel.innerHTML = `
                <div style="margin-bottom: 10px; font-weight: bold; color: #ff6b6b;">DEBUG PANEL</div>
                <button onclick="checkSuperAdmin()" style="display: block; margin: 5px 0; padding: 8px 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">Check Super Admin</button>
                <button onclick="debugPetitionSystem()" style="display: block; margin: 5px 0; padding: 8px 12px; background: #4ecdc4; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">Full System Debug</button>
                <button onclick="forceRefreshPetitions()" style="display: block; margin: 5px 0; padding: 8px 12px; background: #45b7d1; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">Force Refresh</button>
                <button onclick="createSingleTestPetition()" style="display: block; margin: 5px 0; padding: 8px 12px; background: #96ceb4; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">Create 1 Test</button>
                <button onclick="createTestPetitions()" style="display: block; margin: 5px 0; padding: 8px 12px; background: #feca57; color: black; border: none; border-radius: 4px; cursor: pointer; width: 100%;">Create 3 Tests</button>
                <div style="margin-top: 10px; font-size: 10px; color: #999;">Check browser console for detailed logs</div>
            `;
            document.body.appendChild(debugPanel);
        }

        // Make debug functions globally available
        window.checkSuperAdmin = checkSuperAdmin;
        window.createSingleTestPetition = createSingleTestPetition;
        window.createTestPetitions = createTestPetitions;

        // Quick function to create a single test petition
        window.createSingleTestPetition = async function () {
            try {
                const testPetition = {
                    userId: 'test-user-' + Date.now(),
                    userEmail: 'test.writer' + Date.now() + '@example.com',
                    fullName: 'Test Writer ' + new Date().toLocaleTimeString(),
                    writingExperience: 'I am an experienced writer with a passion for storytelling and content creation.',
                    contentPlan: 'I plan to write engaging articles about various topics including technology, lifestyle, and personal development.',
                    writingSample: 'Writing is more than just putting words on paper‚Äîit is about connecting with readers and sharing meaningful experiences that resonate with their lives.',
                    motivation: 'I want to contribute valuable content to this platform and help build a community of engaged readers.',
                    status: 'pending',
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    reviewedAt: null,
                    reviewedBy: null,
                    reviewNotes: null
                };

                await firebase.firestore()
                    .collection('writer-petitions')
                    .add(testPetition);

                console.log('Single test petition created!');
                alert('Test petition created successfully!');
                loadPetitions(); // Refresh the list
            } catch (error) {
                console.error('Error creating single test petition:', error);
                alert('Error: ' + error.message);
            }
        };

        // Comprehensive debugging function
        window.debugPetitionSystem = async function () {
            console.log('=== PETITION SYSTEM DEBUG ===');

            try {
                // 1. Check Firebase Auth
                console.log('1. Firebase Auth User:', firebase.auth().currentUser?.email || 'Not authenticated');

                // 2. Check Firestore connection
                console.log('2. Testing Firestore connection...');
                const testDoc = await firebase.firestore().collection('test').doc('test').get();
                console.log('   Firestore connection: OK');

                // 3. Check user permissions
                if (currentUser) {
                    const userDoc = await firebase.firestore().collection('users').doc(currentUser.uid).get();
                    const userData = userDoc.data();
                    console.log('3. User role:', userData?.role || 'No user document found');
                    console.log('   Is Super Admin:', userData?.role === 'super_admin');
                }

                // 4. Direct petition collection check
                console.log('4. Checking writer-petitions collection...');
                const petitionsRef = firebase.firestore().collection('writer-petitions');
                const snapshot = await petitionsRef.get();
                console.log('   Collection exists:', !snapshot.empty);
                console.log('   Document count:', snapshot.size);

                // 5. List all petition documents
                if (!snapshot.empty) {
                    console.log('5. Petition documents:');
                    snapshot.docs.forEach((doc, index) => {
                        const data = doc.data();
                        console.log(`   ${index + 1}. ID: ${doc.id}`);
                        console.log(`      Name: ${data.fullName}`);
                        console.log(`      Email: ${data.userEmail}`);
                        console.log(`      Status: ${data.status}`);
                        console.log(`      Submitted: ${data.submittedAt?.toDate?.() || data.submittedAt}`);
                    });
                } else {
                    console.log('5. No petition documents found in collection');
                }

                // 6. Test creating a petition
                console.log('6. Testing petition creation...');
                const testPetition = {
                    userId: 'debug-test-' + Date.now(),
                    userEmail: 'debug@test.com',
                    fullName: 'Debug Test User',
                    writingExperience: 'Debug test experience',
                    contentPlan: 'Debug test content plan',
                    writingSample: 'This is a debug test writing sample.',
                    motivation: 'Debug test motivation',
                    status: 'pending',
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                const docRef = await firebase.firestore().collection('writer-petitions').add(testPetition);
                console.log('   Test petition created with ID:', docRef.id);

                // 7. Re-check collection after creation
                const newSnapshot = await petitionsRef.get();
                console.log('7. After test creation - Document count:', newSnapshot.size);

                console.log('=== DEBUG COMPLETE ===');
                alert('Debug complete! Check console for detailed results.');

                // Refresh the petition list
                loadPetitions();

            } catch (error) {
                console.error('DEBUG ERROR:', error);
                alert('Debug failed: ' + error.message);
            }
        };

        // Simple function to force refresh petitions with detailed logging
        window.forceRefreshPetitions = async function () {
            console.log('=== FORCE REFRESH PETITIONS ===');
            try {
                const snapshot = await firebase.firestore().collection('writer-petitions').get();
                console.log('Raw snapshot size:', snapshot.size);
                console.log('Raw snapshot empty:', snapshot.empty);

                if (snapshot.empty) {
                    console.log('Collection is empty - no petitions exist');
                    document.getElementById('petitionsContainer').innerHTML = `
                        <div class="empty-state">
                            <h3>No petitions found</h3>
                            <p>The writer-petitions collection is empty.</p>
                            <button onclick="createTestPetitions()" style="margin-top: 10px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Create Test Petitions</button>
                        </div>
                    `;
                } else {
                    await loadPetitions();
                }
            } catch (error) {
                console.error('Force refresh error:', error);
                alert('Refresh failed: ' + error.message);
            }
        };

        console.log('üéØ Petition Management Dashboard loaded');
        console.log('üí° Add ?debug=true to URL to see visual debug panel');
        console.log('');
        console.log('üîß Available debug functions:');
        console.log('ÔøΩ checkSuperAdmin() - Check and fix super admin status');
        console.log('ÔøΩüìä debugPetitionSystem() - Complete system diagnosis');
        console.log('üîÑ forceRefreshPetitions() - Force refresh with detailed logging');
        console.log('üìù createSingleTestPetition() - Create one test petition');
        console.log('üìö createTestPetitions() - Create multiple test petitions');
        console.log('');
        console.log('üö® If you get "Missing or insufficient permissions":');
        console.log('   1. Make sure you are logged in as Super Administrator (Alfredoxrock)');
        console.log('   2. Run checkSuperAdmin() to verify/fix your admin status');
        console.log('   3. Run debugPetitionSystem() for full diagnosis');
        console.log('   4. Check the Firebase Authentication tab to confirm you are logged in');
    </script>
</body>

</html>